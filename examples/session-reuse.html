<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>rembg-web - Session Reuse Example</title>
    <script src="https://unpkg.com/onnxruntime-web@latest/dist/ort.min.js"></script>
    <script src="https://unpkg.com/@bunnio/rembg-web@latest/dist/index.umd.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
      }
      .container {
        display: flex;
        gap: 20px;
        margin: 20px 0;
      }
      .image-container {
        flex: 1;
        text-align: center;
      }
      .image-container img {
        max-width: 100%;
        height: auto;
        border: 1px solid #ddd;
        border-radius: 8px;
      }
      .controls {
        margin: 20px 0;
        text-align: center;
      }
      .model-selector {
        margin: 15px 0;
      }
      .model-selector select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }
      input[type='file'] {
        margin: 10px;
      }
      button {
        background: #17a2b8;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #138496;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .loading {
        display: none;
        color: #17a2b8;
      }
      .error {
        display: none;
        color: #dc3545;
        background: #f8d7da;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }
      .info {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 5px;
        margin: 20px 0;
      }
      .stats {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin: 20px 0;
      }
      .stats h4 {
        margin-top: 0;
      }
      .stats div {
        margin: 5px 0;
      }
    </style>
  </head>
  <body>
    <h1>rembg-web - Session Reuse Example</h1>
    <p>
      This example demonstrates how to reuse sessions for better performance
      when processing multiple images.
    </p>

    <div class="info">
      <strong>Session Reuse:</strong> By creating a session once and reusing it
      for multiple images, you can significantly improve performance since the
      model only needs to be loaded once. This is especially beneficial when
      processing multiple images in sequence.
    </div>

    <div class="stats">
      <h4>Performance Stats</h4>
      <div>Session created: <span id="sessionCreated">No</span></div>
      <div>Images processed: <span id="imageCount">0</span></div>
      <div>Total processing time: <span id="totalTime">0ms</span></div>
      <div>Average time per image: <span id="avgTime">0ms</span></div>
    </div>

    <div class="controls">
      <div class="model-selector">
        <label for="modelSelect">Select Model:</label>
        <select id="modelSelect">
          <option value="u2net">U2Net (General)</option>
          <option value="u2netp">U2NetP (Lightweight)</option>
          <option value="u2net_human_seg">U2Net Human Segmentation</option>
          <option value="u2net_cloth_seg">U2Net Cloth Segmentation</option>
        </select>
      </div>
      <input type="file" id="fileInput" accept="image/*" multiple />
      <button id="createSessionBtn">Create Session</button>
      <button id="processBtn" disabled>Process Images</button>
      <button id="clearSessionBtn" disabled>Clear Session</button>
      <div class="loading" id="loading">Processing...</div>
      <div class="error" id="error"></div>
    </div>

    <div class="container">
      <div class="image-container">
        <h3>Original Images</h3>
        <div id="originalImages"></div>
      </div>
      <div class="image-container">
        <h3>Processed Images</h3>
        <div id="processedImages"></div>
      </div>
    </div>

    <script type="module">
      const { remove, newSession, rembgConfig } = RembgWeb;

      // Configure model base URL
      rembgConfig.setBaseUrl(
        'https://github.com/bunn-io/rembg-web/releases/download/base-models'
      );

      // Get DOM elements
      const fileInput = document.getElementById('fileInput');
      const modelSelect = document.getElementById('modelSelect');
      const createSessionBtn = document.getElementById('createSessionBtn');
      const processBtn = document.getElementById('processBtn');
      const clearSessionBtn = document.getElementById('clearSessionBtn');
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      const originalImages = document.getElementById('originalImages');
      const processedImages = document.getElementById('processedImages');
      const sessionCreated = document.getElementById('sessionCreated');
      const imageCount = document.getElementById('imageCount');
      const totalTime = document.getElementById('totalTime');
      const avgTime = document.getElementById('avgTime');

      // State
      let session = null;
      let processedCount = 0;
      let totalProcessingTime = 0;

      // Show/hide loading state
      function setLoading(isLoading) {
        loading.style.display = isLoading ? 'block' : 'none';
        createSessionBtn.disabled = isLoading;
        processBtn.disabled = isLoading || !session;
      }

      // Show error message
      function showError(message) {
        error.textContent = message;
        error.style.display = 'block';
      }

      // Hide error message
      function hideError() {
        error.style.display = 'none';
      }

      // Update stats
      function updateStats() {
        sessionCreated.textContent = session ? 'Yes' : 'No';
        imageCount.textContent = processedCount;
        totalTime.textContent = `${totalProcessingTime}ms`;
        avgTime.textContent =
          processedCount > 0
            ? `${Math.round(totalProcessingTime / processedCount)}ms`
            : '0ms';
      }

      // Create session
      async function createSession() {
        try {
          setLoading(true);
          hideError();

          const modelName = modelSelect.value;
          console.log(`Creating session for model: ${modelName}`);

          session = newSession(modelName);
          await session.initialize();

          console.log('Session created successfully');
          createSessionBtn.disabled = true;
          processBtn.disabled = false;
          clearSessionBtn.disabled = false;
          updateStats();
        } catch (err) {
          console.error('Error creating session:', err);
          showError(`Error creating session: ${err.message}`);
        } finally {
          setLoading(false);
        }
      }

      // Clear session
      function clearSession() {
        if (session) {
          session.dispose();
          session = null;
          processedCount = 0;
          totalProcessingTime = 0;

          createSessionBtn.disabled = false;
          processBtn.disabled = true;
          clearSessionBtn.disabled = true;

          originalImages.innerHTML = '';
          processedImages.innerHTML = '';
          updateStats();

          console.log('Session cleared');
        }
      }

      // Process images
      async function processImages() {
        const files = Array.from(fileInput.files);
        if (files.length === 0) {
          showError('Please select image files first.');
          return;
        }

        if (!session) {
          showError('Please create a session first.');
          return;
        }

        try {
          setLoading(true);
          hideError();

          // Clear previous results
          originalImages.innerHTML = '';
          processedImages.innerHTML = '';

          const startTime = Date.now();

          // Process each image
          for (let i = 0; i < files.length; i++) {
            const file = files[i];
            console.log(
              `Processing image ${i + 1}/${files.length}: ${file.name}`
            );

            // Show original image
            const originalUrl = URL.createObjectURL(file);
            const originalImg = document.createElement('img');
            originalImg.src = originalUrl;
            originalImg.style.margin = '5px';
            originalImg.style.maxWidth = '200px';
            originalImages.appendChild(originalImg);

            // Process with reused session
            const imageStartTime = Date.now();
            const processedBlob = await remove(file, {
              session: session,
              postProcessMask: true,
            });
            const imageEndTime = Date.now();

            const imageProcessingTime = imageEndTime - imageStartTime;
            totalProcessingTime += imageProcessingTime;
            processedCount++;

            // Show processed image
            const processedUrl = URL.createObjectURL(processedBlob);
            const processedImg = document.createElement('img');
            processedImg.src = processedUrl;
            processedImg.style.margin = '5px';
            processedImg.style.maxWidth = '200px';
            processedImages.appendChild(processedImg);

            console.log(`Image ${i + 1} processed in ${imageProcessingTime}ms`);
            updateStats();
          }

          const totalTime = Date.now() - startTime;
          console.log(`All images processed in ${totalTime}ms`);
        } catch (err) {
          console.error('Error processing images:', err);
          showError(`Error processing images: ${err.message}`);
        } finally {
          setLoading(false);
        }
      }

      // Event listeners
      createSessionBtn.addEventListener('click', createSession);
      processBtn.addEventListener('click', processImages);
      clearSessionBtn.addEventListener('click', clearSession);

      fileInput.addEventListener('change', e => {
        if (e.target.files.length > 0) {
          hideError();
        }
      });

      // Initialize stats
      updateStats();
    </script>
  </body>
</html>
