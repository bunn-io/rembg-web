<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>rembg-web - Pixel Comparison Tool</title>
        <script src="https://unpkg.com/onnxruntime-web@latest/dist/ort.min.js"></script>
        <script src="https://unpkg.com/@bunnio/rembg-web@latest/dist/index.umd.js"></script>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 1400px;
                margin: 0 auto;
                padding: 20px;
            }
            .container {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 20px;
                margin: 20px 0;
            }
            .image-container {
                text-align: center;
                border: 2px dashed #ddd;
                border-radius: 8px;
                padding: 20px;
                min-height: 300px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                position: relative;
            }
            .image-container.drag-over {
                border-color: #007bff;
                background-color: #f8f9fa;
            }
            .image-container img {
                max-width: 100%;
                max-height: 400px;
                border: 1px solid #ddd;
                border-radius: 4px;
                margin: 10px 0;
            }
            .drop-zone {
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                color: #666;
                cursor: pointer;
            }
            .drop-zone.has-image {
                display: none;
            }
            .controls {
                margin: 20px 0;
                text-align: center;
            }
            button {
                background: #007bff;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 5px;
                cursor: pointer;
                margin: 5px;
                font-size: 16px;
            }
            button:hover {
                background: #0056b3;
            }
            button:disabled {
                background: #ccc;
                cursor: not-allowed;
            }
            .stats {
                background: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                padding: 20px;
                margin: 20px 0;
                text-align: center;
            }
            .stats h3 {
                margin-top: 0;
                color: #333;
            }
            .stat-item {
                display: flex;
                justify-content: space-between;
                margin: 10px 0;
                padding: 8px 0;
                border-bottom: 1px solid #eee;
            }
            .stat-item:last-child {
                border-bottom: none;
                font-weight: bold;
                font-size: 18px;
                color: #007bff;
            }
            .error {
                display: none;
                color: #dc3545;
                background: #f8d7da;
                padding: 10px;
                border-radius: 5px;
                margin: 10px 0;
            }
            .info {
                background: #d1ecf1;
                color: #0c5460;
                padding: 15px;
                border-radius: 5px;
                margin: 20px 0;
            }
            .loading {
                display: none;
                color: #007bff;
                font-weight: bold;
            }
            .threshold-control,
            .comparison-modes,
            .difference-modes {
                margin: 15px 0;
            }
            .threshold-control label,
            .comparison-modes label,
            .difference-modes label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
            }
            .threshold-control input {
                width: 200px;
                margin: 0 10px;
            }
            .threshold-control span {
                font-weight: bold;
                color: #007bff;
            }
            .comparison-modes select,
            .difference-modes select {
                padding: 5px 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
                min-width: 200px;
            }
            .clear-btn {
                position: absolute;
                top: 10px;
                right: 10px;
                background: #dc3545;
                color: white;
                border: none;
                border-radius: 50%;
                width: 30px;
                height: 30px;
                cursor: pointer;
                font-size: 16px;
                display: none;
            }
            .clear-btn:hover {
                background: #c82333;
            }
            .image-container.has-image .clear-btn {
                display: block;
            }
        </style>
    </head>
    <body>
        <h1>rembg-web - Pixel Comparison Tool</h1>
        <p>
            This tool compares two images pixel by pixel and highlights the
            differences. Perfect for testing and comparing the output of
            different models or processing methods.
        </p>

        <div class="info">
            <strong>How to use:</strong> Drag and drop or click to select two
            images. Choose your comparison mode and difference visualization,
            then click Compare Images. The tool provides multiple comparison
            methods for accurate analysis:
            <ul>
                <li>
                    <strong>Canvas Rendering:</strong> Traditional
                    pixel-by-pixel comparison (may have precision issues)
                </li>
                <li>
                    <strong>Direct File Comparison:</strong> Byte-by-byte file
                    comparison (most accurate for identical files)
                </li>
                <li>
                    <strong>Hash Comparison:</strong> SHA-256 hash comparison
                    (fastest for identical file detection)
                </li>
            </ul>
            Use threshold 0 for maximum sensitivity to detect even the smallest
            differences.
        </div>

        <div class="controls">
            <div class="threshold-control">
                <label for="thresholdSlider"
                    >Difference Threshold (0-255):</label
                >
                <input
                    type="range"
                    id="thresholdSlider"
                    min="0"
                    max="255"
                    value="0"
                />
                <span id="thresholdValue">0</span>
                <small>(Lower values = more sensitive to differences)</small>
            </div>
            <div class="comparison-modes">
                <label for="comparisonMode">Comparison Mode:</label>
                <select id="comparisonMode">
                    <option value="canvas">Canvas Rendering (Current)</option>
                    <option value="direct">Direct File Comparison</option>
                    <option value="hash">File Hash Comparison</option>
                </select>
            </div>
            <div class="difference-modes">
                <label for="differenceMode">Difference Visualization:</label>
                <select id="differenceMode">
                    <option value="highlight">
                        Highlight Differences (Red)
                    </option>
                    <option value="heatmap">Heatmap (Intensity)</option>
                    <option value="overlay">Overlay Mode</option>
                    <option value="side-by-side">Side by Side</option>
                </select>
            </div>
            <button id="compareBtn" disabled>Compare Images</button>
            <button id="exportBtn" disabled>Export Analysis</button>
            <button id="clearAllBtn">Clear All</button>
            <div class="loading" id="loading">Comparing images...</div>
            <div class="error" id="error"></div>
        </div>

        <div class="stats" id="stats" style="display: none">
            <h3>Comparison Statistics</h3>
            <div class="stat-item">
                <span>Comparison Mode:</span>
                <span id="comparisonModeUsed">-</span>
            </div>
            <div class="stat-item">
                <span>Image 1 Dimensions:</span>
                <span id="img1Dimensions">-</span>
            </div>
            <div class="stat-item">
                <span>Image 2 Dimensions:</span>
                <span id="img2Dimensions">-</span>
            </div>
            <div class="stat-item">
                <span>Total Pixels:</span>
                <span id="totalPixels">-</span>
            </div>
            <div class="stat-item">
                <span>Different Pixels:</span>
                <span id="differentPixels">-</span>
            </div>
            <div class="stat-item">
                <span>Percentage Different:</span>
                <span id="percentageDifferent">-</span>
            </div>
            <div class="stat-item">
                <span>Max Difference:</span>
                <span id="maxDifference">-</span>
            </div>
            <div class="stat-item">
                <span>Average Difference:</span>
                <span id="averageDifference">-</span>
            </div>
            <div class="stat-item">
                <span>File Hash Match:</span>
                <span id="hashMatch">-</span>
            </div>
            <div class="stat-item">
                <span>Identical:</span>
                <span id="identical" style="font-weight: bold; font-size: 18px"
                    >-</span
                >
            </div>
        </div>

        <div class="container">
            <div class="image-container" id="image1Container">
                <div class="drop-zone" id="dropZone1">
                    <div style="font-size: 48px; margin-bottom: 10px">📁</div>
                    <div>Drop Image 1 here</div>
                    <div style="font-size: 12px; margin-top: 5px">
                        or click to select
                    </div>
                </div>
                <img id="image1" style="display: none" alt="Image 1" />
                <button class="clear-btn" id="clear1">×</button>
            </div>

            <div class="image-container" id="image2Container">
                <div class="drop-zone" id="dropZone2">
                    <div style="font-size: 48px; margin-bottom: 10px">📁</div>
                    <div>Drop Image 2 here</div>
                    <div style="font-size: 12px; margin-top: 5px">
                        or click to select
                    </div>
                </div>
                <img id="image2" style="display: none" alt="Image 2" />
                <button class="clear-btn" id="clear2">×</button>
            </div>

            <div class="image-container" id="diffContainer">
                <div class="drop-zone" id="dropZoneDiff">
                    <div style="font-size: 48px; margin-bottom: 10px">🔍</div>
                    <div>Difference Highlight</div>
                    <div style="font-size: 12px; margin-top: 5px">
                        Will appear here
                    </div>
                </div>
                <img
                    id="diffImage"
                    style="display: none"
                    alt="Difference Image"
                />
            </div>
        </div>

        <script type="module">
            // Get DOM elements
            const image1Container = document.getElementById('image1Container');
            const image2Container = document.getElementById('image2Container');
            const diffContainer = document.getElementById('diffContainer');
            const dropZone1 = document.getElementById('dropZone1');
            const dropZone2 = document.getElementById('dropZone2');
            const dropZoneDiff = document.getElementById('dropZoneDiff');
            const image1 = document.getElementById('image1');
            const image2 = document.getElementById('image2');
            const diffImage = document.getElementById('diffImage');
            const compareBtn = document.getElementById('compareBtn');
            const exportBtn = document.getElementById('exportBtn');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const clear1Btn = document.getElementById('clear1');
            const clear2Btn = document.getElementById('clear2');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const stats = document.getElementById('stats');
            const thresholdSlider = document.getElementById('thresholdSlider');
            const thresholdValue = document.getElementById('thresholdValue');
            const comparisonMode = document.getElementById('comparisonMode');
            const differenceMode = document.getElementById('differenceMode');

            // State
            let image1Data = null;
            let image2Data = null;
            let threshold = 0;
            let lastComparisonResult = null;

            // Update threshold display
            thresholdSlider.addEventListener('input', e => {
                threshold = parseInt(e.target.value);
                thresholdValue.textContent = threshold;
                if (image1Data && image2Data) {
                    compareImages();
                }
            });

            // Show/hide loading state
            function setLoading(isLoading) {
                loading.style.display = isLoading ? 'block' : 'none';
                compareBtn.disabled = isLoading;
            }

            // Show error message
            function showError(message) {
                error.textContent = message;
                error.style.display = 'block';
            }

            // Hide error message
            function hideError() {
                error.style.display = 'none';
            }

            // Update compare button state
            function updateCompareButton() {
                compareBtn.disabled = !image1Data || !image2Data;
                exportBtn.disabled = !lastComparisonResult;
            }

            // Calculate file hash
            async function calculateFileHash(file) {
                const buffer = await file.arrayBuffer();
                const hashBuffer = await crypto.subtle.digest(
                    'SHA-256',
                    buffer
                );
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('');
            }

            // Direct file comparison (without canvas rendering)
            async function compareFilesDirectly(file1, file2) {
                const arrayBuffer1 = await file1.arrayBuffer();
                const arrayBuffer2 = await file2.arrayBuffer();

                if (arrayBuffer1.byteLength !== arrayBuffer2.byteLength) {
                    return {
                        identical: false,
                        totalPixels: 0,
                        differentPixels: 1,
                        percentageDifferent: 100,
                        maxDifference: 255,
                        averageDifference: 255,
                        hashMatch: false,
                    };
                }

                const bytes1 = new Uint8Array(arrayBuffer1);
                const bytes2 = new Uint8Array(arrayBuffer2);

                let differentBytes = 0;
                let maxDifference = 0;
                let totalDifference = 0;

                for (let i = 0; i < bytes1.length; i++) {
                    const diff = Math.abs(bytes1[i] - bytes2[i]);
                    if (diff > 0) differentBytes++;
                    maxDifference = Math.max(maxDifference, diff);
                    totalDifference += diff;
                }

                const averageDifference =
                    bytes1.length > 0 ? totalDifference / bytes1.length : 0;
                const percentageDifferent =
                    bytes1.length > 0
                        ? (differentBytes / bytes1.length) * 100
                        : 0;

                return {
                    identical: differentBytes === 0,
                    totalPixels: bytes1.length,
                    differentPixels: differentBytes,
                    percentageDifferent,
                    maxDifference,
                    averageDifference,
                    hashMatch: differentBytes === 0,
                };
            }

            // Load image from file
            function loadImage(
                file,
                container,
                imageElement,
                dropZone,
                dataRef
            ) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const img = new Image();
                        img.onload = () => {
                            imageElement.src = e.target.result;
                            imageElement.style.display = 'block';
                            dropZone.style.display = 'none';
                            container.classList.add('has-image');

                            // Store image data
                            dataRef.current = {
                                file: file,
                                image: img,
                                canvas: null,
                            };

                            // Update the global variables directly
                            if (container === image1Container) {
                                image1Data = dataRef.current;
                            } else if (container === image2Container) {
                                image2Data = dataRef.current;
                            }

                            updateCompareButton();
                            hideError();
                            resolve();
                        };
                        img.onerror = () =>
                            reject(new Error('Failed to load image'));
                        img.src = e.target.result;
                    };
                    reader.onerror = () =>
                        reject(new Error('Failed to read file'));
                    reader.readAsDataURL(file);
                });
            }

            // Clear image
            function clearImage(container, imageElement, dropZone, dataRef) {
                imageElement.src = '';
                imageElement.style.display = 'none';
                dropZone.style.display = 'flex';
                container.classList.remove('has-image');
                dataRef.current = null;
                updateCompareButton();
                hideStats();
            }

            // Hide stats
            function hideStats() {
                stats.style.display = 'none';
                diffImage.style.display = 'none';
                dropZoneDiff.style.display = 'flex';
            }

            // Convert image to canvas
            function imageToCanvas(img) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                ctx.drawImage(img, 0, 0);
                return canvas;
            }

            // Compare images pixel by pixel
            async function compareImages() {
                if (!image1Data || !image2Data) return;

                try {
                    setLoading(true);
                    hideError();

                    const mode = comparisonMode.value;
                    let result;

                    if (mode === 'hash') {
                        // Hash comparison
                        const hash1 = await calculateFileHash(image1Data.file);
                        const hash2 = await calculateFileHash(image2Data.file);
                        const hashMatch = hash1 === hash2;

                        result = {
                            identical: hashMatch,
                            totalPixels: 0,
                            differentPixels: hashMatch ? 0 : 1,
                            percentageDifferent: hashMatch ? 0 : 100,
                            maxDifference: hashMatch ? 0 : 255,
                            averageDifference: hashMatch ? 0 : 255,
                            hashMatch,
                            mode: 'Hash Comparison',
                            dimensions: {
                                width1: image1Data.image.naturalWidth,
                                height1: image1Data.image.naturalHeight,
                                width2: image2Data.image.naturalWidth,
                                height2: image2Data.image.naturalHeight,
                            },
                        };
                    } else if (mode === 'direct') {
                        // Direct file comparison
                        result = await compareFilesDirectly(
                            image1Data.file,
                            image2Data.file
                        );
                        result.mode = 'Direct File Comparison';
                        result.dimensions = {
                            width1: image1Data.image.naturalWidth,
                            height1: image1Data.image.naturalHeight,
                            width2: image2Data.image.naturalWidth,
                            height2: image2Data.image.naturalHeight,
                        };
                    } else {
                        // Canvas comparison (original method)
                        result = await compareImagesCanvas();
                    }

                    lastComparisonResult = result;
                    updateStats(result);
                    updateDifferenceVisualization(result);
                    updateCompareButton();
                } catch (err) {
                    console.error('Error comparing images:', err);
                    showError(`Error comparing images: ${err.message}`);
                } finally {
                    setLoading(false);
                }
            }

            // Canvas-based comparison (original method)
            async function compareImagesCanvas() {
                const canvas1 = imageToCanvas(image1Data.image);
                const canvas2 = imageToCanvas(image2Data.image);

                const ctx1 = canvas1.getContext('2d');
                const ctx2 = canvas2.getContext('2d');

                const imageData1 = ctx1.getImageData(
                    0,
                    0,
                    canvas1.width,
                    canvas1.height
                );
                const imageData2 = ctx2.getImageData(
                    0,
                    0,
                    canvas2.width,
                    canvas2.height
                );

                // Check if dimensions match
                if (
                    canvas1.width !== canvas2.width ||
                    canvas1.height !== canvas2.height
                ) {
                    throw new Error(
                        'Images must have the same dimensions to compare'
                    );
                }

                let differentPixels = 0;
                let maxDifference = 0;
                let totalDifference = 0;
                const totalPixels = canvas1.width * canvas1.height;

                // Compare pixels
                for (let i = 0; i < imageData1.data.length; i += 4) {
                    const r1 = imageData1.data[i];
                    const g1 = imageData1.data[i + 1];
                    const b1 = imageData1.data[i + 2];
                    const a1 = imageData1.data[i + 3];

                    const r2 = imageData2.data[i];
                    const g2 = imageData2.data[i + 1];
                    const b2 = imageData2.data[i + 2];
                    const a2 = imageData2.data[i + 3];

                    // Calculate difference
                    const rDiff = Math.abs(r1 - r2);
                    const gDiff = Math.abs(g1 - g2);
                    const bDiff = Math.abs(b1 - b2);
                    const aDiff = Math.abs(a1 - a2);

                    const maxDiff = Math.max(rDiff, gDiff, bDiff, aDiff);
                    maxDifference = Math.max(maxDifference, maxDiff);
                    totalDifference += maxDiff;

                    if (maxDiff > threshold) {
                        differentPixels++;
                    }
                }

                const averageDifference =
                    totalPixels > 0 ? totalDifference / totalPixels : 0;
                const percentageDifferent =
                    totalPixels > 0 ? (differentPixels / totalPixels) * 100 : 0;

                return {
                    identical: differentPixels === 0,
                    totalPixels,
                    differentPixels,
                    percentageDifferent,
                    maxDifference,
                    averageDifference,
                    hashMatch: differentPixels === 0,
                    mode: 'Canvas Rendering',
                    dimensions: {
                        width1: canvas1.width,
                        height1: canvas1.height,
                        width2: canvas2.width,
                        height2: canvas2.height,
                    },
                    canvas1,
                    canvas2,
                    imageData1,
                    imageData2,
                };
            }

            // Update statistics display
            function updateStats(result) {
                document.getElementById('comparisonModeUsed').textContent =
                    result.mode;
                document.getElementById('img1Dimensions').textContent =
                    `${result.dimensions.width1} × ${result.dimensions.height1}`;
                document.getElementById('img2Dimensions').textContent =
                    `${result.dimensions.width2} × ${result.dimensions.height2}`;
                document.getElementById('totalPixels').textContent =
                    result.totalPixels.toLocaleString();
                document.getElementById('differentPixels').textContent =
                    result.differentPixels.toLocaleString();
                document.getElementById('percentageDifferent').textContent =
                    `${result.percentageDifferent.toFixed(2)}%`;
                document.getElementById('maxDifference').textContent =
                    result.maxDifference.toFixed(2);
                document.getElementById('averageDifference').textContent =
                    result.averageDifference.toFixed(2);
                document.getElementById('hashMatch').textContent =
                    result.hashMatch ? 'Yes' : 'No';

                const identicalElement = document.getElementById('identical');
                identicalElement.textContent = result.identical ? 'Yes' : 'No';
                identicalElement.style.color = result.identical
                    ? '#28a745'
                    : '#dc3545';

                stats.style.display = 'block';
            }

            // Update difference visualization
            function updateDifferenceVisualization(result) {
                if (
                    result.mode === 'Hash Comparison' ||
                    result.mode === 'Direct File Comparison'
                ) {
                    // For non-canvas modes, show simple message
                    diffImage.style.display = 'none';
                    dropZoneDiff.style.display = 'flex';
                    dropZoneDiff.innerHTML = `
            <div style="font-size: 48px; margin-bottom: 10px">${result.identical ? '✅' : '❌'}</div>
            <div>${result.identical ? 'Files are identical' : 'Files are different'}</div>
            <div style="font-size: 12px; margin-top: 5px">${result.mode}</div>
          `;
                    return;
                }

                // Canvas-based visualization
                const diffCanvas = document.createElement('canvas');
                const diffCtx = diffCanvas.getContext('2d');
                diffCanvas.width = result.dimensions.width1;
                diffCanvas.height = result.dimensions.height1;

                const diffImageData = diffCtx.createImageData(
                    result.dimensions.width1,
                    result.dimensions.height1
                );

                const mode = differenceMode.value;
                const { imageData1, imageData2 } = result;

                // Generate difference visualization based on mode
                for (let i = 0; i < imageData1.data.length; i += 4) {
                    const r1 = imageData1.data[i];
                    const g1 = imageData1.data[i + 1];
                    const b1 = imageData1.data[i + 2];
                    const a1 = imageData1.data[i + 3];

                    const r2 = imageData2.data[i];
                    const g2 = imageData2.data[i + 1];
                    const b2 = imageData2.data[i + 2];
                    const a2 = imageData2.data[i + 3];

                    const rDiff = Math.abs(r1 - r2);
                    const gDiff = Math.abs(g1 - g2);
                    const bDiff = Math.abs(b1 - b2);
                    const aDiff = Math.abs(a1 - a2);
                    const maxDiff = Math.max(rDiff, gDiff, bDiff, aDiff);

                    if (mode === 'highlight') {
                        if (maxDiff > threshold) {
                            diffImageData.data[i] = 255; // R
                            diffImageData.data[i + 1] = 0; // G
                            diffImageData.data[i + 2] = 0; // B
                            diffImageData.data[i + 3] = 255; // A
                        } else {
                            diffImageData.data[i] = r1;
                            diffImageData.data[i + 1] = g1;
                            diffImageData.data[i + 2] = b1;
                            diffImageData.data[i + 3] = a1;
                        }
                    } else if (mode === 'heatmap') {
                        const intensity = Math.min(255, maxDiff * 2);
                        diffImageData.data[i] = intensity; // R
                        diffImageData.data[i + 1] = 0; // G
                        diffImageData.data[i + 2] = 255 - intensity; // B
                        diffImageData.data[i + 3] = 255; // A
                    } else if (mode === 'overlay') {
                        diffImageData.data[i] = Math.floor((r1 + r2) / 2);
                        diffImageData.data[i + 1] = Math.floor((g1 + g2) / 2);
                        diffImageData.data[i + 2] = Math.floor((b1 + b2) / 2);
                        diffImageData.data[i + 3] = Math.floor((a1 + a2) / 2);
                    } else if (mode === 'side-by-side') {
                        const x = Math.floor(
                            (i / 4) % result.dimensions.width1
                        );
                        if (x < result.dimensions.width1 / 2) {
                            diffImageData.data[i] = r1;
                            diffImageData.data[i + 1] = g1;
                            diffImageData.data[i + 2] = b1;
                            diffImageData.data[i + 3] = a1;
                        } else {
                            diffImageData.data[i] = r2;
                            diffImageData.data[i + 1] = g2;
                            diffImageData.data[i + 2] = b2;
                            diffImageData.data[i + 3] = a2;
                        }
                    }
                }

                diffCtx.putImageData(diffImageData, 0, 0);
                diffImage.src = diffCanvas.toDataURL();
                diffImage.style.display = 'block';
                dropZoneDiff.style.display = 'none';
            }

            // Drag and drop handlers
            function setupDragAndDrop(
                container,
                dropZone,
                imageElement,
                dataRef
            ) {
                // Prevent default drag behaviors
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(
                    eventName => {
                        container.addEventListener(
                            eventName,
                            preventDefaults,
                            false
                        );
                    }
                );

                // Highlight drop zone when item is dragged over it
                ['dragenter', 'dragover'].forEach(eventName => {
                    container.addEventListener(
                        eventName,
                        () => {
                            container.classList.add('drag-over');
                        },
                        false
                    );
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    container.addEventListener(
                        eventName,
                        () => {
                            container.classList.remove('drag-over');
                        },
                        false
                    );
                });

                // Handle dropped files
                container.addEventListener(
                    'drop',
                    e => {
                        const files = e.dataTransfer.files;
                        if (files.length > 0) {
                            const file = files[0];
                            if (file.type.startsWith('image/')) {
                                loadImage(
                                    file,
                                    container,
                                    imageElement,
                                    dropZone,
                                    dataRef
                                ).catch(err =>
                                    showError(
                                        `Error loading image: ${err.message}`
                                    )
                                );
                            } else {
                                showError('Please drop an image file');
                            }
                        }
                    },
                    false
                );

                // Handle click to select file
                dropZone.addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.onchange = e => {
                        if (e.target.files.length > 0) {
                            const file = e.target.files[0];
                            loadImage(
                                file,
                                container,
                                imageElement,
                                dropZone,
                                dataRef
                            ).catch(err =>
                                showError(`Error loading image: ${err.message}`)
                            );
                        }
                    };
                    input.click();
                });
            }

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            // Export analysis results
            function exportAnalysis() {
                if (!lastComparisonResult) return;

                const exportData = {
                    timestamp: new Date().toISOString(),
                    comparisonMode: lastComparisonResult.mode,
                    threshold: threshold,
                    results: {
                        identical: lastComparisonResult.identical,
                        totalPixels: lastComparisonResult.totalPixels,
                        differentPixels: lastComparisonResult.differentPixels,
                        percentageDifferent:
                            lastComparisonResult.percentageDifferent,
                        maxDifference: lastComparisonResult.maxDifference,
                        averageDifference:
                            lastComparisonResult.averageDifference,
                        hashMatch: lastComparisonResult.hashMatch,
                    },
                    dimensions: lastComparisonResult.dimensions,
                    files: {
                        image1: {
                            name: image1Data.file.name,
                            size: image1Data.file.size,
                            type: image1Data.file.type,
                        },
                        image2: {
                            name: image2Data.file.name,
                            size: image2Data.file.size,
                            type: image2Data.file.type,
                        },
                    },
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                    type: 'application/json',
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `image-comparison-${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // Event listeners
            compareBtn.addEventListener('click', compareImages);
            exportBtn.addEventListener('click', exportAnalysis);
            clearAllBtn.addEventListener('click', () => {
                clearImage(image1Container, image1, dropZone1, image1DataRef);
                clearImage(image2Container, image2, dropZone2, image2DataRef);
                image1Data = null;
                image2Data = null;
                lastComparisonResult = null;
                updateCompareButton();
            });
            clear1Btn.addEventListener('click', () => {
                clearImage(image1Container, image1, dropZone1, image1DataRef);
                image1Data = null;
                lastComparisonResult = null;
                updateCompareButton();
            });
            clear2Btn.addEventListener('click', () => {
                clearImage(image2Container, image2, dropZone2, image2DataRef);
                image2Data = null;
                lastComparisonResult = null;
                updateCompareButton();
            });

            // Re-compare when mode changes
            comparisonMode.addEventListener('change', () => {
                if (image1Data && image2Data) {
                    compareImages();
                }
            });

            differenceMode.addEventListener('change', () => {
                if (
                    lastComparisonResult &&
                    lastComparisonResult.mode === 'Canvas Rendering'
                ) {
                    updateDifferenceVisualization(lastComparisonResult);
                }
            });

            // Create data reference objects
            const image1DataRef = { current: null };
            const image2DataRef = { current: null };

            // Setup drag and drop for both containers
            setupDragAndDrop(image1Container, dropZone1, image1, image1DataRef);
            setupDragAndDrop(image2Container, dropZone2, image2, image2DataRef);
        </script>
    </body>
</html>
